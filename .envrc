# If nix is available, enable flakes
if has nix; then
    use flake
fi

# Where we "install" locally
export CAELESTIA_PREFIX="$PWD/.local"
export CAELESTIA_LIB_DIR="$CAELESTIA_PREFIX/lib"
export QML2_IMPORT_PATH="$CAELESTIA_PREFIX/lib/qt6/qml:${QML2_IMPORT_PATH:-}"
export PATH="$CAELESTIA_PREFIX/bin:$PATH"

# Configure build directory once
if [ ! -f build/Makefile ] && [ ! -f build/build.ninja ]; then
    cmake -S . -B build \
      -G Ninja \
      -DCMAKE_BUILD_TYPE=RelWithDebInfo \
      -DCMAKE_CXX_COMPILER=clazy \
      -DCMAKE_INSTALL_PREFIX=$CAELESTIA_PREFIX \
      -DINSTALL_LIBDIR=lib/caelestia \
      -DINSTALL_QMLDIR=lib/qt6/qml \
      -DINSTALL_QSCONFDIR=etc/xdg/quickshell/caelestia \
      -DCMAKE_BUILD_WITH_INSTALL_RPATH=ON \
      -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
fi

# Rebuild automatically when C++ sources or CMake files change
shopt -s globstar
watch_file plugin/**/*.cpp
watch_file plugin/**/*.hpp
watch_file **/CMakeLists.txt

cmake --build build
cmake --install build

# Symlink config dir so QuickShell loads Caelestia from source
mkdir -p ~/.config/quickshell
ln -sf "$PWD" ~/.config/quickshell/caelestia
